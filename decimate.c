// based on https://github.com/projectNe10/Ne10/blob/master/modules/dsp/NE10_fir.c
// with some changes

#include <string.h>
#include "decimate.h"

#define NUMTAPS   545
#define NUMBLOCKS 8
#define BLOCKSIZE 4800
#define BUFFSIZE  (NUMBLOCKS * BLOCKSIZE)


// kaiser window (N = 545, beta = 5.65326)
float coeffs[NUMTAPS] = 
{ 2.06626719e-05,  2.19730100e-05, -1.05480799e-19, -2.47187636e-05,
 -2.61557161e-05, -2.19049291e-19,  2.91616689e-05,  3.07322516e-05,
 -1.46420005e-18, -3.40126389e-05, -3.57240715e-05,  1.23001333e-18,
  3.92935362e-05,  4.11532419e-05, -8.77038407e-19, -4.50268381e-05,
 -4.70424457e-05,  3.88843932e-19,  5.12356455e-05,  5.34150022e-05,
  2.52144425e-19, -5.79436964e-05, -6.02948494e-05, -1.06468309e-18,
  6.51753653e-05,  6.77065909e-05, -2.54552054e-18, -7.29556850e-05,
 -7.56754671e-05,  1.86430235e-18,  8.13103543e-05,  8.42274167e-05,
 -9.86614506e-19, -9.02657484e-05, -9.33890333e-05, -1.09676743e-19,
  9.98489559e-05,  1.03187653e-04, -2.05041551e-18, -1.10087771e-04,
 -1.13651316e-04,  7.95972691e-19,  1.21010751e-04,  1.24808823e-04,
 -3.49468837e-18, -1.32647183e-04, -1.36689734e-04,  2.07113225e-18,
  1.45027196e-04,  1.49324434e-04, -3.47336215e-19, -1.58181734e-04,
 -1.62744152e-04,  3.78818446e-18,  1.72142580e-04,  1.76981004e-04,
 -1.85216017e-18, -1.86942460e-04, -1.92067993e-04, -4.47230604e-19,
  2.02615047e-04,  2.08039142e-04, -3.86624715e-18, -2.19195048e-04,
 -2.24929492e-04,  1.30499839e-18,  2.36718188e-04,  2.42775175e-04,
  1.69116539e-18, -2.55221385e-04, -2.61613459e-04,  3.64021094e-18,
  2.74742750e-04,  2.81482906e-04, -3.25371313e-19, -2.95321719e-04,
 -3.02423403e-04,  6.65701681e-18,  3.16999067e-04,  3.24476190e-04,
 -3.00541951e-18, -3.39817139e-04, -3.47684196e-04, -1.20866204e-18,
  3.63819854e-04,  3.72091890e-04, -6.45790947e-18, -3.89052962e-04,
 -3.97745578e-04,  1.83925160e-18,  4.15564049e-04,  4.24693601e-04,
 -1.08032617e-17, -4.43402794e-04, -4.52986336e-04,  5.75885128e-18,
  4.72621177e-04,  4.82676551e-04,  1.40915700e-21, -5.03273623e-04,
 -5.13819570e-04,  1.06833461e-17,  5.35417290e-04,  5.46473544e-04,
 -4.41643971e-18, -5.69112250e-04, -5.80699532e-04, -2.68353293e-18,
  6.04422006e-04,  6.16562204e-04, -9.96213813e-18, -6.41413440e-04,
 -6.54129777e-04,  2.26288595e-18,  6.80157566e-04,  6.93474605e-04,
  6.40254296e-18, -7.20729760e-04, -7.34673755e-04,  8.47246856e-18,
  7.63210235e-04,  7.77809124e-04,  8.98955901e-19, -8.07684672e-04,
 -8.22968257e-04,  1.61291815e-17,  8.54244689e-04,  8.70244985e-04,
 -6.01722280e-18, -9.02988657e-04, -9.19740007e-04, -5.30264959e-18,
  9.54022224e-04,  9.71561705e-04, -1.45531791e-17, -1.00745959e-03,
 -1.02582725e-03,  2.36170694e-18,  1.06342405e-03,  1.08266319e-03,
 -2.49443179e-17, -1.12204952e-03, -1.14220742e-03,  1.18395428e-17,
  1.18348154e-03,  1.20460952e-03,  2.77757013e-18, -1.24787888e-03,
 -1.27003319e-03,  2.34011976e-17,  1.31541537e-03,  1.33865757e-03,
 -7.70558528e-18, -1.38628157e-03, -1.41067931e-03,  1.38054426e-17,
  1.46068737e-03,  1.48631516e-03, -2.05353080e-17, -1.53886422e-03,
 -1.56580471e-03,  1.80008129e-18,  1.62106857e-03,  1.64941337e-03,
 -8.54356225e-18, -1.70758541e-03, -1.73743651e-03,  1.60016766e-17,
  1.79873232e-03,  1.83020369e-03,  6.32547992e-18, -1.89486449e-03,
 -1.92808383e-03,  1.10693444e-18,  1.99638051e-03,  2.03149160e-03,
 -9.35464014e-18, -2.10372964e-03, -2.14089500e-03,  1.84892337e-17,
  2.21741991e-03,  2.25682347e-03, -2.85908494e-17, -2.33802828e-03,
 -2.37987959e-03, -3.46304293e-21,  2.46621273e-03,  2.51075160e-03,
 -1.01214051e-17, -2.60272669e-03, -2.65022879e-03,  2.13754488e-17,
  2.74843816e-03,  2.79922178e-03,  1.29100783e-17, -2.90435110e-03,
 -2.95878551e-03, -1.70944794e-18,  3.07163317e-03,  3.13015003e-03,
 -1.08268148e-17, -3.25165130e-03, -3.31475795e-03,  2.48555466e-17,
  3.44601530e-03,  3.51431128e-03, -4.05608675e-17, -3.65663366e-03,
 -3.73083353e-03, -4.31243457e-18,  3.88578675e-03,  3.96674918e-03,
 -1.14547392e-17, -4.13622102e-03, -4.22498537e-03,  2.93060099e-17,
  4.41127457e-03,  4.50911233e-03, -1.17349847e-17, -4.71504405e-03,
 -4.82352637e-03, -8.38300567e-18,  5.05261263e-03,  5.17370459e-03,
 -1.19904909e-17, -5.43036498e-03, -5.56655647e-03,  3.55263750e-17,
  5.85643249e-03,  6.01092447e-03, -1.22197266e-17, -6.34133024e-03,
 -6.51830854e-03, -1.51776492e-17,  6.89889956e-03,  7.10394513e-03,
 -1.24213080e-17, -7.54773384e-03, -7.78845279e-03,  4.55072785e-17,
  8.31340533e-03,  8.60043988e-03, -1.25940126e-17, -9.23207682e-03,
 -9.58078355e-03,  1.26692000e-17,  1.03566078e-02,  1.07899914e-02,
 -1.27367865e-17, -1.17674526e-02, -1.23215858e-02,  1.27966685e-17,
  1.35933431e-02,  1.43281696e-02, -1.28487536e-17, -1.60539020e-02,
 -1.70768108e-02,  1.28929631e-17,  1.95570141e-02,  2.10811272e-02,
 -1.29292275e-17, -2.49555539e-02, -2.74710972e-02,  1.29574915e-17,
  3.43817398e-02,  3.93138416e-02, -1.29777119e-17, -5.50851636e-02,
 -6.88779280e-02,  1.29898557e-17,  1.37813121e-01,  2.75654912e-01,
  3.33333343e-01,  2.75654912e-01,  1.37813121e-01,  1.29898557e-17,
 -6.88779280e-02, -5.50851636e-02, -1.29777119e-17,  3.93138416e-02,
  3.43817398e-02,  1.29574915e-17, -2.74710972e-02, -2.49555539e-02,
 -1.29292275e-17,  2.10811272e-02,  1.95570141e-02,  1.28929631e-17,
 -1.70768108e-02, -1.60539020e-02, -1.28487536e-17,  1.43281696e-02,
  1.35933431e-02,  1.27966685e-17, -1.23215858e-02, -1.17674526e-02,
 -1.27367865e-17,  1.07899914e-02,  1.03566078e-02,  1.26692000e-17,
 -9.58078355e-03, -9.23207682e-03, -1.25940126e-17,  8.60043988e-03,
  8.31340533e-03,  4.55072785e-17, -7.78845279e-03, -7.54773384e-03,
 -1.24213080e-17,  7.10394513e-03,  6.89889956e-03, -1.51776492e-17,
 -6.51830854e-03, -6.34133024e-03, -1.22197266e-17,  6.01092447e-03,
  5.85643249e-03,  3.55263750e-17, -5.56655647e-03, -5.43036498e-03,
 -1.19904909e-17,  5.17370459e-03,  5.05261263e-03, -8.38300567e-18,
 -4.82352637e-03, -4.71504405e-03, -1.17349847e-17,  4.50911233e-03,
  4.41127457e-03,  2.93060099e-17, -4.22498537e-03, -4.13622102e-03,
 -1.14547392e-17,  3.96674918e-03,  3.88578675e-03, -4.31243457e-18,
 -3.73083353e-03, -3.65663366e-03, -4.05608675e-17,  3.51431128e-03,
  3.44601530e-03,  2.48555466e-17, -3.31475795e-03, -3.25165130e-03,
 -1.08268148e-17,  3.13015003e-03,  3.07163317e-03, -1.70944794e-18,
 -2.95878551e-03, -2.90435110e-03,  1.29100783e-17,  2.79922178e-03,
  2.74843816e-03,  2.13754488e-17, -2.65022879e-03, -2.60272669e-03,
 -1.01214051e-17,  2.51075160e-03,  2.46621273e-03, -3.46304293e-21,
 -2.37987959e-03, -2.33802828e-03, -2.85908494e-17,  2.25682347e-03,
  2.21741991e-03,  1.84892337e-17, -2.14089500e-03, -2.10372964e-03,
 -9.35464014e-18,  2.03149160e-03,  1.99638051e-03,  1.10693444e-18,
 -1.92808383e-03, -1.89486449e-03,  6.32547992e-18,  1.83020369e-03,
  1.79873232e-03,  1.60016766e-17, -1.73743651e-03, -1.70758541e-03,
 -8.54356225e-18,  1.64941337e-03,  1.62106857e-03,  1.80008129e-18,
 -1.56580471e-03, -1.53886422e-03, -2.05353080e-17,  1.48631516e-03,
  1.46068737e-03,  1.38054426e-17, -1.41067931e-03, -1.38628157e-03,
 -7.70558528e-18,  1.33865757e-03,  1.31541537e-03,  2.34011976e-17,
 -1.27003319e-03, -1.24787888e-03,  2.77757013e-18,  1.20460952e-03,
  1.18348154e-03,  1.18395428e-17, -1.14220742e-03, -1.12204952e-03,
 -2.49443179e-17,  1.08266319e-03,  1.06342405e-03,  2.36170694e-18,
 -1.02582725e-03, -1.00745959e-03, -1.45531791e-17,  9.71561705e-04,
  9.54022224e-04, -5.30264959e-18, -9.19740007e-04, -9.02988657e-04,
 -6.01722280e-18,  8.70244985e-04,  8.54244689e-04,  1.61291815e-17,
 -8.22968257e-04, -8.07684672e-04,  8.98955901e-19,  7.77809124e-04,
  7.63210235e-04,  8.47246856e-18, -7.34673755e-04, -7.20729760e-04,
  6.40254296e-18,  6.93474605e-04,  6.80157566e-04,  2.26288595e-18,
 -6.54129777e-04, -6.41413440e-04, -9.96213813e-18,  6.16562204e-04,
  6.04422006e-04, -2.68353293e-18, -5.80699532e-04, -5.69112250e-04,
 -4.41643971e-18,  5.46473544e-04,  5.35417290e-04,  1.06833461e-17,
 -5.13819570e-04, -5.03273623e-04,  1.40915700e-21,  4.82676551e-04,
  4.72621177e-04,  5.75885128e-18, -4.52986336e-04, -4.43402794e-04,
 -1.08032617e-17,  4.24693601e-04,  4.15564049e-04,  1.83925160e-18,
 -3.97745578e-04, -3.89052962e-04, -6.45790947e-18,  3.72091890e-04,
  3.63819854e-04, -1.20866204e-18, -3.47684196e-04, -3.39817139e-04,
 -3.00541951e-18,  3.24476190e-04,  3.16999067e-04,  6.65701681e-18,
 -3.02423403e-04, -2.95321719e-04, -3.25371313e-19,  2.81482906e-04,
  2.74742750e-04,  3.64021094e-18, -2.61613459e-04, -2.55221385e-04,
  1.69116539e-18,  2.42775175e-04,  2.36718188e-04,  1.30499839e-18,
 -2.24929492e-04, -2.19195048e-04, -3.86624715e-18,  2.08039142e-04,
  2.02615047e-04, -4.47230604e-19, -1.92067993e-04, -1.86942460e-04,
 -1.85216017e-18,  1.76981004e-04,  1.72142580e-04,  3.78818446e-18,
 -1.62744152e-04, -1.58181734e-04, -3.47336215e-19,  1.49324434e-04,
  1.45027196e-04,  2.07113225e-18, -1.36689734e-04, -1.32647183e-04,
 -3.49468837e-18,  1.24808823e-04,  1.21010751e-04,  7.95972691e-19,
 -1.13651316e-04, -1.10087771e-04, -2.05041551e-18,  1.03187653e-04,
  9.98489559e-05, -1.09676743e-19, -9.33890333e-05, -9.02657484e-05,
 -9.86614506e-19,  8.42274167e-05,  8.13103543e-05,  1.86430235e-18,
 -7.56754671e-05, -7.29556850e-05, -2.54552054e-18,  6.77065909e-05,
  6.51753653e-05, -1.06468309e-18, -6.02948494e-05, -5.79436964e-05,
  2.52144425e-19,  5.34150022e-05,  5.12356455e-05,  3.88843932e-19,
 -4.70424457e-05, -4.50268381e-05, -8.77038407e-19,  4.11532419e-05,
  3.92935362e-05,  1.23001333e-18, -3.57240715e-05, -3.40126389e-05,
 -1.46420005e-18,  3.07322516e-05,  2.91616689e-05, -2.19049291e-19,
 -2.61557161e-05, -2.47187636e-05, -1.05480799e-19,  2.19730100e-05,
  2.06626719e-05};


int decimate_init (
    decimate_t * S,
    uint16_t numTaps,
    uint8_t M,
    float * pCoeffs,
    int32_t * pState,
    uint32_t blockSize)
{
    int status;

    /* The size of the input block must be a multiple of the decimation factor */
    if ( (blockSize % M) != 0u)
    {
        status = -1;
    }
    else
    {
        /* Assign filter taps */
        S->numTaps = numTaps;

        /* Assign coefficient pointer */
        S->pCoeffs = pCoeffs;

        /* Clear state buffer and size is always (blockSize + numTaps - 1) */
        memset (pState, 0, (numTaps + (blockSize - 1u)) * sizeof (int32_t));

        /* Assign state pointer */
        S->pState = pState;

        /* Assign Decimation Factor */
        S->M = M;

        S->outBlockSize = blockSize / M;

        status = 0;
    }

    return (status);

}

void decimate_process (const decimate_t * S,
                                int32_t * pSrc,
                                int32_t * pDst)
{
    int32_t *pState = S->pState;                 /* State pointer */
    int32_t *pStateCurnt;                        /* Points to the current sample of the state */
    int32_t *px;
    int32_t x0;
    float *pCoeffs = S->pCoeffs;             /* Coefficient pointer */
    float *pb;                               /* Temporary pointers for state and coefficient buffers */
    float sum0;                              /* Accumulator */
    float c0;                                /* Temporary variables to hold state and coefficient values */
    uint32_t numTaps = S->numTaps;               /* Number of filter coefficients in the filter */
    uint32_t i, tapCnt, blkCnt;                  /* Loop counters */


    /* Run the below code for Cortex-M4 and Cortex-M3 */

    /* S->pState buffer contains previous frame (numTaps - 1) samples */
    /* pStateCurnt points to the location where the new input data should be written */
    pStateCurnt = S->pState + (numTaps - 1u);

    /* Total number of output samples to be computed */
    blkCnt = S->outBlockSize;

    while (blkCnt > 0u)
    {
        /* Copy decimation factor number of new input samples into the state buffer */
        i = S->M;

        do
        {
            *pStateCurnt++ = *pSrc++;

        }
        while (--i);

        /* Set accumulator to zero */
        sum0 = 0.0f;

        /* Initialize state pointer */
        px = pState;

        /* Initialize coeff pointer */
        pb = pCoeffs;

        /* Loop unrolling.  Process 4 taps at a time. */
        tapCnt = numTaps >> 2;

        /* Loop over the number of taps.  Unroll by a factor of 4.
         ** Repeat until we've computed numTaps-4 coefficients. */
        while (tapCnt > 0u)
        {
            /* Read the b[numTaps-1] coefficient */
            c0 = * (pb++);

            /* Read x[n-numTaps-1] sample */
            x0 = * (px++);

            /* Perform the multiply-accumulate */
            sum0 += x0 * c0;

            /* Read the b[numTaps-2] coefficient */
            c0 = * (pb++);

            /* Read x[n-numTaps-2] sample */
            x0 = * (px++);

            /* Perform the multiply-accumulate */
            sum0 += x0 * c0;

            /* Read the b[numTaps-3] coefficient */
            c0 = * (pb++);

            /* Read x[n-numTaps-3] sample */
            x0 = * (px++);

            /* Perform the multiply-accumulate */
            sum0 += x0 * c0;

            /* Read the b[numTaps-4] coefficient */
            c0 = * (pb++);

            /* Read x[n-numTaps-4] sample */
            x0 = * (px++);

            /* Perform the multiply-accumulate */
            sum0 += x0 * c0;

            /* Decrement the loop counter */
            tapCnt--;
        }

        /* If the filter length is not a multiple of 4, compute the remaining filter taps */
        tapCnt = numTaps % 0x4u;

        while (tapCnt > 0u)
        {
            /* Read coefficients */
            c0 = * (pb++);

            /* Fetch 1 state variable */
            x0 = * (px++);

            /* Perform the multiply-accumulate */
            sum0 += x0 * c0;

            /* Decrement the loop counter */
            tapCnt--;
        }

        /* Advance the state pointer by the decimation factor
         * to process the next group of decimation factor number samples */
        pState = pState + S->M;

        /* The result is in the accumulator, store in the destination buffer. */
        *pDst++ = (int32_t)sum0;

        /* Decrement the loop counter */
        blkCnt--;
    }

    /* Processing is complete.
     ** Now copy the last numTaps - 1 samples to the satrt of the state buffer.
     ** This prepares the state buffer for the next function call. */

    /* Points to the start of the state buffer */
    pStateCurnt = S->pState;

    i = (numTaps - 1u) >> 2;

    /* copy data */
    while (i > 0u)
    {
        *pStateCurnt++ = *pState++;
        *pStateCurnt++ = *pState++;
        *pStateCurnt++ = *pState++;
        *pStateCurnt++ = *pState++;

        /* Decrement the loop counter */
        i--;
    }

    i = (numTaps - 1u) % 0x04u;

    /* copy data */
    while (i > 0u)
    {
        *pStateCurnt++ = *pState++;

        /* Decrement the loop counter */
        i--;
    }

}

